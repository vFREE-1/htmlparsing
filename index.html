<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown解析器</title>
  <!-- 引入代码高亮样式 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <!-- 自定义样式 -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f6f8fa;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    .markdown-container {
      background: #fff;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .error {
      color: #dc3545;
      background: #f8d7da;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    /* Markdown 基础样式（仿GitHub） */
    .markdown-container h1, .markdown-container h2, .markdown-container h3 {
      margin: 24px 0 16px;
      font-weight: 600;
      line-height: 1.25;
      border-bottom: 1px solid #eaecef;
      padding-bottom: 0.3em;
    }
    .markdown-container h1 { font-size: 2em; }
    .markdown-container h2 { font-size: 1.5em; }
    .markdown-container h3 { font-size: 1.25em; border-bottom: none; }
    .markdown-container p { margin: 16px 0; }
    .markdown-container pre {
      background: #f6f8fa;
      padding: 16px;
      border-radius: 6px;
      overflow: auto;
      margin: 16px 0;
    }
    .markdown-container code {
      font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.875em;
      padding: 0.2em 0.4em;
      margin: 0;
      background-color: rgba(27,31,35,0.05);
      border-radius: 3px;
    }
    .markdown-container pre code { padding: 0; background: none; }
    .markdown-container ul, .markdown-container ol {
      padding-left: 2em;
      margin: 16px 0;
    }
    .markdown-container li { margin: 4px 0; }
    .markdown-container a {
      color: #0366d6;
      text-decoration: none;
    }
    .markdown-container a:hover { text-decoration: underline; }
    .markdown-container blockquote {
      margin: 16px 0;
      padding: 0 1em;
      color: #6a737d;
      border-left: 4px solid #dfe2e5;
    }
    .markdown-container img {
      max-width: 100%;
      border-radius: 6px;
      margin: 16px 0;
    }
    /* 响应式适配 */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .markdown-container { padding: 20px; }
    }
  </style>
</head>
<body>
  <div id="markdownContent" class="markdown-container"></div>

  <!-- 引入解析库 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

  <script>
    // 配置marked解析器（启用GFM和代码高亮）
    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try {
            return hljs.highlight(code, { language: lang }).value;
          } catch (err) {
            console.error('代码高亮失败:', err);
          }
        }
        // 自动识别语言降级处理
        try {
          return hljs.highlightAuto(code).value;
        } catch (err) {
          console.error('自动高亮失败:', err);
        }
        return code;
      },
      breaks: true,    // 支持换行符
      gfm: true,       // 启用GitHub风格Markdown
      headerIds: false // 禁用自动生成header ID
    });

    /**
     * 获取URL中的GET参数
     * @param {string} name - 参数名
     * @returns {string|null} 参数值
     */
    function getQueryParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    /**
     * 解码URL安全的Base64字符串
     * @param {string} encodedStr - Base64编码字符串
     * @returns {string} 解码后的UTF-8文本
     */
    function decodeSafeBase64(encodedStr) {
      // 还原URL安全的Base64字符（-→+，_→/）
      encodedStr = encodedStr.replace(/-/g, '+').replace(/_/g, '/');
      // 补全Base64 padding（=）
      while (encodedStr.length % 4) encodedStr += '=';
      
      try {
        // 解码Base64并处理UTF-8编码
        const decoded = atob(encodedStr);
        return decodeURIComponent(escape(decoded));
      } catch (err) {
        throw new Error(`Base64解码失败: ${err.message}`);
      }
    }

    /**
     * 初始化解析逻辑
     */
    function initParser() {
      const mdBase64 = getQueryParam('md');
      const contentEl = document.getElementById('markdownContent');

      // 无md参数时显示提示
      if (!mdBase64) {
        contentEl.className = 'error';
        contentEl.innerHTML = `
          <h3>使用说明</h3>
          <p>请在URL后添加 GET 参数：?md=【Markdown内容的Base64编码】</p>
          <p>示例：${window.location.href}?md=5L2g5aW95rWL6K+V5pWF56ug</p>
          <p>提示：Base64编码建议使用URL安全格式（+→-，/→_，去掉=）</p>
        `;
        return;
      }

      // 解析流程
      try {
        const mdText = decodeSafeBase64(mdBase64); // 解码Base64
        const html = marked.parse(mdText);          // 解析Markdown
        contentEl.innerHTML = html;                 // 渲染到页面
      } catch (err) {
        // 解析失败显示错误信息
        contentEl.className = 'error';
        contentEl.innerHTML = `
          <h3>解析失败</h3>
          <p>错误信息：${err.message}</p>
          <p>请检查：</p>
          <ul>
            <li>Base64编码是否正确</li>
            <li>Markdown内容是否合法</li>
            <li>是否使用了URL安全的Base64格式</li>
          </ul>
        `;
        console.error('解析异常:', err);
      }
    }

    // 页面加载完成后执行解析
    window.addEventListener('DOMContentLoaded', initParser);
  </script>
</body>
</html>
